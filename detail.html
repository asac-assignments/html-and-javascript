<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail TODO List</title>
  </head>
  <body>
    <section id="container">
      <h1 class="title">TODO LIST</h1>
      <div class="input-container">
        <input type="text" class="todo-input" onkeyup="Save()" />
      </div>
      <div class="filter-container">
        <select id="todo-filter" onchange="filterList()">
          <option value="all">전체</option>
          <option value="todo">할일</option>
          <option value="done">완료</option>
        </select>
      </div>
      <div class="list-container">
        <ul id="todo-list" class="todo-list"></ul>
      </div>
    </section>
  </body>
  <script>
    let todoListArray = [];
    function loadLocalStorageItem() {
      if (todoListArray.length === 0) {
        const todolist = JSON.parse(localStorage.getItem(`todoListStorage`));
        if (todolist !== null) {
          todolist.forEach((item) => {
            CreateTodoListItemElement(item.value);
          });
        }
      }
    }
    loadLocalStorageItem();
    function onEnter() {
      if (window.event.keyCode == 13) {
        return true;
      }
    }
    function createKey(value) {
      const eigenvalue = Date.now();
      return value + eigenvalue;
    }

    function Save() {
      const input_object = document.querySelector(".todo-input");
      const input_object_content = input_object.value.trim();
      if ((input_object_content !== "") & onEnter()) {
        CreateTodoListItemElement(input_object_content);
        input_object.value = "";
      }
    }

    function addElementToEvent(element, fn) {
      if (element) {
        element.addEventListener("click", fn);
      }
    }
    function addElement(elementName) {
      return document.createElement(elementName);
    }

    function setLocalStorage(value) {
      localStorage.setItem(`todoListStorage`, JSON.stringify(value));
    }

    function addTodoItemToLocalStorage(element, content) {
      const key = createKey(content);
      const pushItem = { key: key, value: content };
      todoListArray.push(pushItem);
      setLocalStorage(todoListArray);
      element.setAttribute(`data-key`, key);
    }

    function editTodoItemToLocalStorage(element, updated_content) {
      const editItemKey = element.getAttribute("data-key");
      todoListArray.map((item) => {
        if (item.key === editItemKey) {
          item.value = updated_content;
        }
      });
      setLocalStorage(todoListArray);
    }

    function filterTodoItemById(todoList, key) {
      return todoList.filter((item) => item.key !== key);
    }

    function deleteTodoItemToLocalStorage(element) {
      const deleteItemKey = element.getAttribute("data-key");
      todoListArray = filterTodoItemById(todoListArray, deleteItemKey);
      setLocalStorage(todoListArray);
      localStorage.removeItem(deleteItemKey);
    }

    function CreateTodoListItemElement(content) {
      const todo_list_li = addElement("li");
      const todo_list_checkBox = addElement("input");
      const todo_list_span = addElement("span");
      const todo_list_edit_button = addElement("button");
      const todo_list_delete_button = addElement("button");

      todo_list_checkBox.type = "checkbox";
      todo_list_span.textContent = content;
      todo_list_edit_button.textContent = "Edit";
      todo_list_delete_button.textContent = "X";

      addElementToEvent(todo_list_checkBox, () => filterList());
      addElementToEvent(todo_list_edit_button, () =>
        editTodoItem(todo_list_li, todo_list_span)
      );
      addElementToEvent(todo_list_delete_button, () =>
        deleteTodoItem(todo_list_li)
      );
      addTodoItemToLocalStorage(todo_list_li, content);

      todo_list_li.appendChild(todo_list_checkBox);
      todo_list_li.appendChild(todo_list_span);
      todo_list_li.appendChild(todo_list_edit_button);
      todo_list_li.appendChild(todo_list_delete_button);

      document.getElementById("todo-list").appendChild(todo_list_li);
    }

    function editTodoItem(li, span) {
      const li_buttons = li.querySelectorAll("button");
      li_buttons.forEach((button) => (button.style.display = "none"));
      span.style.display = "none";
      const edit_input = addElement("input");
      const edit_save = addElement("button");
      edit_save.textContent = "Save";
      edit_input.value = span.textContent;
      li.appendChild(edit_input);
      li.appendChild(edit_save);
      edit_save.onclick = () => {
        const updated_content = edit_input.value.trim();
        if (updated_content !== "") {
          span.textContent = updated_content;
          editTodoItemToLocalStorage(li, updated_content);
        }
        li.removeChild(edit_input);
        li.removeChild(edit_save);
        span.style.display = "inline";
        li_buttons.forEach((button) => (button.style.display = "inline"));
      };
    }

    function deleteTodoItem(li) {
      const todo_list = document.querySelector("#todo-list");
      deleteTodoItemToLocalStorage(li);
      if (todo_list.contains(li)) {
        todo_list.removeChild(li);
      }
    }

    function filterList() {
      const filter_value = document.getElementById("todo-filter").value;
      const todo_items = document.querySelectorAll("#todo-list li");
      todo_items.forEach((item) => {
        const checkbox = item.querySelector("input[type='checkbox']");
        item.style.display = "list-item";
        if (filter_value === "todo" && checkbox.checked) {
          item.style.display = "none";
        } else if (filter_value === "done" && !checkbox.checked) {
          item.style.display = "none";
        }
      });
    }
  </script>
</html>
